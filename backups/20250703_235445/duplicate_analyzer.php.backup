<?php
/**
 * EDS Duplicate Cleaner - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
 * –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ Phosphor Icons
 */

// –û–±—Ä–∞–±–æ—Ç–∫–∞ AJAX –∑–∞–ø—Ä–æ—Å–æ–≤
if (isset($_POST['action'])) {
	// –í–∫–ª—é—á–∞–µ–º –æ—Ç–ª–∞–¥–∫—É
	error_reporting(E_ALL);
	ini_set('display_errors', 1);

	header('Content-Type: application/json; charset=utf-8');

	try {
		$action = $_POST['action'];
		$cleaner = new DuplicateCleaner();

		// –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
		error_log("DuplicateCleaner: –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏–µ - " . $action);

		switch ($action) {
			case 'scan':
				error_log("DuplicateCleaner: –ù–∞—á–∏–Ω–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ");
				$result = $cleaner->scanFiles($_POST);
				error_log("DuplicateCleaner: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ, –Ω–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: " . count($result['files']));
				echo json_encode($result, JSON_UNESCAPED_UNICODE);
				break;

			case 'preview':
				error_log("DuplicateCleaner: –ü—Ä–µ–≤—å—é —Ñ–∞–π–ª–∞: " . $_POST['file']);
				$result = $cleaner->previewFile($_POST['file']);
				echo json_encode($result, JSON_UNESCAPED_UNICODE);
				break;

			case 'clean':
				error_log("DuplicateCleaner: –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤");
				$files = json_decode($_POST['files'], true);
				$result = $cleaner->cleanFiles($files);
				error_log("DuplicateCleaner: –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: " . $result['processed_files']);
				echo json_encode($result, JSON_UNESCAPED_UNICODE);
				break;

			case 'backup':
				error_log("DuplicateCleaner: –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤");
				$files = json_decode($_POST['files'], true);
				$result = $cleaner->createBackup($files);
				echo json_encode($result, JSON_UNESCAPED_UNICODE);
				break;

			default:
				throw new Exception('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: ' . $action);
		}

	} catch (Exception $e) {
		error_log("DuplicateCleaner: –û—à–∏–±–∫–∞ - " . $e->getMessage());
		http_response_code(500);
		echo json_encode(['error' => $e->getMessage()], JSON_UNESCAPED_UNICODE);
	}
	exit;
}

/**
 * –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –æ—á–∏—Å—Ç–∏—Ç–µ–ª—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
 */
class DuplicateCleaner
{
	private $workDir;
	private $backupDir;

	// –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ Phosphor Icons
	private $phosphorPatterns = [
		'/unpkg\.com.*phosphor.*icons/i',
		'/@import.*phosphor/i',
		'/phosphor-icons/i',
		'/<link[^>]*phosphor[^>]*>/i'
	];

	// –≠—Ç–∞–ª–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–Ω–µ —É–¥–∞–ª—è–µ–º –∏–∑ –Ω–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç—ã)
	private $referenceFiles = [
		'main.css',
		'header.css',
		'header.php',
		'index.php'
	];

	public function __construct()
	{
		$this->workDir = getcwd();
		$this->backupDir = $this->workDir . '/backups/' . date('Ymd_His');

		if (!is_dir($this->backupDir)) {
			mkdir($this->backupDir, 0755, true);
		}
	}

	/**
	 * –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
	 */
	public function scanFiles($params)
	{
		$workDir = $params['workDir'] ?? $this->workDir;
		$fileTypes = $params['file_types'] ?? ['css', 'php', 'html'];
		$searchTypes = $params['search_types'] ?? ['phosphor', 'css_vars'];

		$files = $this->findFiles($workDir, $fileTypes);
		$results = [
			'stats' => [
				'total_files' => 0,
				'phosphor_files' => 0,
				'css_var_files' => 0,
				'total_duplicates' => 0
			],
			'files' => []
		];

		foreach ($files as $file) {
			// –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–∞–ª–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
			if (in_array(basename($file), $this->referenceFiles)) {
				continue;
			}

			$analysis = $this->analyzeFile($file, $searchTypes);

			if ($analysis['has_duplicates']) {
				$results['files'][] = [
					'name' => basename($file),
					'path' => $file,
					'phosphor_duplicates' => count($analysis['phosphor_duplicates']),
					'css_duplicates' => count($analysis['css_duplicates'])
				];

				$results['stats']['total_files']++;
				$results['stats']['total_duplicates'] += count($analysis['phosphor_duplicates']) + count($analysis['css_duplicates']);

				if (!empty($analysis['phosphor_duplicates'])) {
					$results['stats']['phosphor_files']++;
				}

				if (!empty($analysis['css_duplicates'])) {
					$results['stats']['css_var_files']++;
				}
			}
		}

		return $results;
	}

	/**
	 * –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤
	 */
	private function findFiles($dir, $types)
	{
		$files = [];
		$excludeDirs = ['node_modules', '.git', 'vendor', 'bitrix/cache', 'upload', 'backups'];

		$iterator = new RecursiveIteratorIterator(
			new RecursiveDirectoryIterator($dir, RecursiveDirectoryIterator::SKIP_DOTS)
		);

		foreach ($iterator as $file) {
			if ($file->isFile()) {
				$relativePath = str_replace($dir . '/', '', $file->getRealPath());

				// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø–∞–ø–∫–∏
				$skip = false;
				foreach ($excludeDirs as $excludeDir) {
					if (strpos($relativePath, $excludeDir) === 0) {
						$skip = true;
						break;
					}
				}

				if ($skip) continue;

				$extension = strtolower($file->getExtension());
				if (in_array($extension, $types)) {
					$files[] = $file->getRealPath();
				}
			}
		}

		return $files;
	}

	/**
	 * –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
	 */
	private function analyzeFile($filePath, $searchTypes)
	{
		$content = file_get_contents($filePath);
		$analysis = [
			'has_duplicates' => false,
			'phosphor_duplicates' => [],
			'css_duplicates' => []
		];

		// –ü–æ–∏—Å–∫ Phosphor Icons
		if (in_array('phosphor', $searchTypes)) {
			$analysis['phosphor_duplicates'] = $this->findPhosphorDuplicates($content);
		}

		// –ü–æ–∏—Å–∫ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
		if (in_array('css_vars', $searchTypes)) {
			$analysis['css_duplicates'] = $this->findCssVarDuplicates($content);
		}

		$analysis['has_duplicates'] = !empty($analysis['phosphor_duplicates']) || !empty($analysis['css_duplicates']);

		return $analysis;
	}

	/**
	 * –ü–æ–∏—Å–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ Phosphor Icons
	 */
	private function findPhosphorDuplicates($content)
	{
		$duplicates = [];
		$lines = explode("\n", $content);

		foreach ($lines as $lineNum => $line) {
			foreach ($this->phosphorPatterns as $pattern) {
				if (preg_match($pattern, $line)) {
					$duplicates[] = [
						'line' => $lineNum + 1,
						'content' => trim($line)
					];
					break;
				}
			}
		}

		return $duplicates;
	}

	/**
	 * –ü–æ–∏—Å–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
	 */
	private function findCssVarDuplicates($content)
	{
		$duplicates = [];
		$referenceVars = $this->getReferenceVars();

		// –ò—â–µ–º –±–ª–æ–∫–∏ :root
		if (preg_match_all('/:root\s*\{([^}]+)\}/s', $content, $matches)) {
			foreach ($matches[1] as $match) {
				$lines = explode("\n", $match);

				foreach ($lines as $line) {
					if (preg_match('/^\s*(--[a-zA-Z0-9-]+):\s*([^;]+);/', $line, $varMatch)) {
						$varName = $varMatch[1];
						$varValue = trim($varMatch[2]);

						if (isset($referenceVars[$varName])) {
							$duplicates[] = [
								'name' => $varName,
								'value' => $varValue,
								'line_content' => trim($line)
							];
						}
					}
				}
			}
		}

		return $duplicates;
	}

	/**
	 * –ü–æ–ª—É—á–µ–Ω–∏–µ —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ main.css
	 */
	private function getReferenceVars()
	{
		static $referenceVars = null;

		if ($referenceVars === null) {
			$referenceVars = [];
			$mainCssPath = $this->findFile('main.css');

			if ($mainCssPath && file_exists($mainCssPath)) {
				$content = file_get_contents($mainCssPath);

				if (preg_match('/:root\s*\{([^}]+)\}/s', $content, $matches)) {
					$rootContent = $matches[1];

					if (preg_match_all('/^\s*(--[a-zA-Z0-9-]+):\s*([^;]+);/m', $rootContent, $varMatches, PREG_SET_ORDER)) {
						foreach ($varMatches as $match) {
							$referenceVars[$match[1]] = trim($match[2]);
						}
					}
				}
			}
		}

		return $referenceVars;
	}

	/**
	 * –ü–æ–∏—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
	 */
	private function findFile($filename)
	{
		$iterator = new RecursiveIteratorIterator(
			new RecursiveDirectoryIterator($this->workDir, RecursiveDirectoryIterator::SKIP_DOTS)
		);

		foreach ($iterator as $file) {
			if ($file->isFile() && $file->getFilename() === $filename) {
				return $file->getRealPath();
			}
		}

		return null;
	}

	/**
	 * –ü—Ä–µ–≤—å—é –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Ñ–∞–π–ª–∞
	 */
	public function previewFile($filePath)
	{
		$analysis = $this->analyzeFile($filePath, ['phosphor', 'css_vars']);

		return [
			'phosphor_changes' => $analysis['phosphor_duplicates'],
			'css_changes' => $analysis['css_duplicates']
		];
	}

	/**
	 * –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤
	 */
	public function createBackup($files)
	{
		$backupCount = 0;

		foreach ($files as $file) {
			$backupPath = $this->backupDir . '/' . basename($file['path']) . '.backup';

			if (copy($file['path'], $backupPath)) {
				$backupCount++;
			}
		}

		return [
			'success' => true,
			'backup_count' => $backupCount,
			'backup_dir' => basename($this->backupDir)
		];
	}

	/**
	 * –û—á–∏—Å—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏–∑ —Ñ–∞–π–ª–æ–≤
	 */
	public function cleanFiles($files)
	{
		// –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø—ã —Å–Ω–∞—á–∞–ª–∞
		$backupResult = $this->createBackup($files);
		if (!$backupResult['success']) {
			return ['success' => false, 'message' => '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø—ã'];
		}

		$processedFiles = 0;
		$totalRemoved = 0;
		$errors = [];

		foreach ($files as $file) {
			try {
				$filePath = $file['path'];

				if (!file_exists($filePath)) {
					$errors[] = "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $filePath";
					continue;
				}

				$removed = $this->cleanFile($filePath);

				if ($removed > 0) {
					$processedFiles++;
					$totalRemoved += $removed;
					error_log("DuplicateCleaner: –û—á–∏—â–µ–Ω —Ñ–∞–π–ª $filePath, —É–¥–∞–ª–µ–Ω–æ: $removed");
				}

			} catch (Exception $e) {
				$errors[] = "–û—à–∏–±–∫–∞ –≤ —Ñ–∞–π–ª–µ {$file['path']}: " . $e->getMessage();
				error_log("DuplicateCleaner: –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ñ–∞–π–ª–∞: " . $e->getMessage());
			}
		}

		return [
			'success' => true,
			'processed_files' => $processedFiles,
			'total_removed' => $totalRemoved,
			'errors' => $errors,
			'backup_dir' => basename($this->backupDir)
		];
	}

	/**
	 * –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
	 */
	private function cleanFile($filePath)
	{
		$content = file_get_contents($filePath);
		$originalContent = $content;
		$removedCount = 0;

		// –£–¥–∞–ª—è–µ–º Phosphor Icons
		$lines = explode("\n", $content);
		$newLines = [];

		foreach ($lines as $line) {
			$shouldRemove = false;

			foreach ($this->phosphorPatterns as $pattern) {
				if (preg_match($pattern, $line)) {
					$shouldRemove = true;
					$removedCount++;
					break;
				}
			}

			if (!$shouldRemove) {
				$newLines[] = $line;
			}
		}

		$content = implode("\n", $newLines);

		// –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
		$referenceVars = $this->getReferenceVars();

		$content = preg_replace_callback(
			'/:root\s*\{([^}]+)\}/s',
			function($matches) use ($referenceVars, &$removedCount) {
				$rootContent = $matches[1];
				$lines = explode("\n", $rootContent);
				$newLines = [];

				foreach ($lines as $line) {
					if (preg_match('/^\s*(--[a-zA-Z0-9-]+):\s*([^;]+);/', $line, $varMatch)) {
						$varName = $varMatch[1];

						if (isset($referenceVars[$varName])) {
							$removedCount++;
							continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç—É –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
						}
					}

					$newLines[] = $line;
				}

				return ':root {' . implode("\n", $newLines) . '}';
			},
			$content
		);

		// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
		if ($content !== $originalContent) {
			file_put_contents($filePath, $content);
		}

		return $removedCount;
	}
}
?>

<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>EDS Duplicate Cleaner - –û—á–∏—Å—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤</title>
	<style>
        :root {
            --primary: #ff2545;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --border: #dee2e6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f6fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
        }

        .card h2 {
            color: var(--dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #e01e3a;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: var(--dark);
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--light);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: var(--success);
            color: #155724;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: var(--danger);
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: var(--info);
            color: #0c5460;
        }

        .file-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            background: var(--light);
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
            cursor: pointer;
        }

        .file-item:hover {
            background: #f0f0f0;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: var(--dark);
        }

        .file-path {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .file-stats {
            font-size: 12px;
            color: var(--primary);
            margin-left: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), #ff6b8a);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .results-section {
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid var(--light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .code-preview {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .diff-removed {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            padding: 2px 5px;
            margin: 1px 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
	</style>
</head>
<body>
<div class="container">
	<!-- Header -->
	<div class="header">
		<h1>EDS Duplicate Cleaner</h1>
		<p>–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ Phosphor Icons</p>
	</div>

	<!-- Alerts will be inserted here -->
	<div id="alertContainer"></div>

	<!-- Configuration Section -->
	<div class="card">
		<h2>üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>

		<form id="scanForm">
			<div class="form-group">
				<label for="workDir">–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:</label>
				<input type="text" id="workDir" name="workDir" class="form-control"
				       value="<?php echo htmlspecialchars(getcwd()); ?>"
				       placeholder="–ü—É—Ç—å –∫ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞">
			</div>

			<div class="form-group">
				<label>–¢–∏–ø—ã —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
				<div class="checkbox-group">
					<div class="checkbox-item">
						<input type="checkbox" id="scan_css" name="file_types[]" value="css" checked>
						<label for="scan_css">CSS —Ñ–∞–π–ª—ã</label>
					</div>
					<div class="checkbox-item">
						<input type="checkbox" id="scan_php" name="file_types[]" value="php" checked>
						<label for="scan_php">PHP —Ñ–∞–π–ª—ã</label>
					</div>
					<div class="checkbox-item">
						<input type="checkbox" id="scan_html" name="file_types[]" value="html" checked>
						<label for="scan_html">HTML —Ñ–∞–π–ª—ã</label>
					</div>
				</div>
			</div>

			<div class="form-group">
				<label>–ß—Ç–æ –∏—Å–∫–∞—Ç—å:</label>
				<div class="checkbox-group">
					<div class="checkbox-item">
						<input type="checkbox" id="find_phosphor" name="search_types[]" value="phosphor" checked>
						<label for="find_phosphor">Phosphor Icons</label>
					</div>
					<div class="checkbox-item">
						<input type="checkbox" id="find_css_vars" name="search_types[]" value="css_vars" checked>
						<label for="find_css_vars">CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ :root</label>
					</div>
				</div>
			</div>

			<button type="button" class="btn btn-primary" onclick="startScan()">
				üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
			</button>

			<button type="button" class="btn btn-info" onclick="showDebugInfo()">
				üêõ –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–∫—É
			</button>
		</form>
	</div>

	<!-- Loading -->
	<div class="loading" id="loadingSection">
		<div class="spinner"></div>
		<h3>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞...</h3>
		<p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤</p>
	</div>

	<!-- Results Section -->
	<div class="results-section" id="resultsSection">
		<!-- Statistics -->
		<div class="card">
			<h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
			<div class="stats-grid" id="statsGrid">
				<!-- Stats will be populated by JavaScript -->
			</div>
		</div>

		<!-- Found Files -->
		<div class="card">
			<h2>üìÅ –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏</h2>
			<div class="file-list" id="filesList">
				<!-- Files will be populated by JavaScript -->
			</div>
		</div>

		<!-- Preview Section -->
		<div class="card">
			<h2>üëÄ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
			<div id="previewContent">
				<p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π</p>
			</div>
		</div>

		<!-- Action Buttons -->
		<div class="card">
			<h2>üéØ –î–µ–π—Å—Ç–≤–∏—è</h2>

			<div class="alert alert-info">
				<strong>‚ÑπÔ∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:</strong> –ü–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –±—ç–∫–∞–ø—ã –≤ –ø–∞–ø–∫–µ <code>backups/</code>
			</div>

			<button type="button" class="btn btn-success" onclick="createBackups()">
				üíæ –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø—ã
			</button>

			<button type="button" class="btn btn-primary" onclick="cleanDuplicates()">
				üßπ –û—á–∏—Å—Ç–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
			</button>
		</div>
	</div>
</div>

<script>
    let scanResults = null;

    async function startScan() {
        console.log('–ù–∞—á–∏–Ω–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...');

        const form = document.getElementById('scanForm');
        const formData = new FormData(form);
        formData.append('action', 'scan');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
        showLoading(true);
        showResults(false);

        try {
            console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...');

            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData
            });

            console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', response.status);

            if (!response.ok) {
                throw new Error(`HTTP –æ—à–∏–±–∫–∞: ${response.status}`);
            }

            const responseText = await response.text();
            console.log('–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:', responseText.substring(0, 200) + '...');

            let data;
            try {
                data = JSON.parse(responseText);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', e);
                throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
            }

            console.log('–î–∞–Ω–Ω—ã–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', data);

            if (data.error) {
                throw new Error(data.error);
            }

            scanResults = data;

            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            showLoading(false);
            showResults(true);

            populateStats(data.stats);
            populateFilesList(data.files);

            showAlert('success', `–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –ù–∞–π–¥–µ–Ω–æ ${data.stats.total_files} —Ñ–∞–π–ª–æ–≤ —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏.`);

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
            showLoading(false);
            showAlert('danger', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏: ' + error.message);
        }
    }

    async function previewFile(file) {
        try {
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–≤—å—é –¥–ª—è —Ñ–∞–π–ª–∞:', file.path);

            const formData = new FormData();
            formData.append('action', 'preview');
            formData.append('file', file.path);

            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData
            });

            const preview = await response.json();
            console.log('–î–∞–Ω–Ω—ã–µ –ø—Ä–µ–≤—å—é:', preview);

            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = `
                    <h4>üìÅ ${file.name}</h4>
                    <p><strong>–ü—É—Ç—å:</strong> ${file.path}</p>

                    ${preview.phosphor_changes && preview.phosphor_changes.length > 0 ? `
                        <h5>üé® –£–¥–∞–ª—è–µ–º—ã–µ Phosphor Icons (${preview.phosphor_changes.length}):</h5>
                        <div class="code-preview">
                            ${preview.phosphor_changes.map(change =>
                `<div class="diff-removed">- –°—Ç—Ä–æ–∫–∞ ${change.line}: ${change.content}</div>`
            ).join('')}
                        </div>
                    ` : ''}

                    ${preview.css_changes && preview.css_changes.length > 0 ? `
                        <h5>üéØ –£–¥–∞–ª—è–µ–º—ã–µ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (${preview.css_changes.length}):</h5>
                        <div class="code-preview">
                            ${preview.css_changes.map(change =>
                `<div class="diff-removed">- ${change.name}: ${change.value}</div>`
            ).join('')}
                        </div>
                    ` : ''}

                    ${(!preview.phosphor_changes || preview.phosphor_changes.length === 0) &&
            (!preview.css_changes || preview.css_changes.length === 0) ?
                '<p>–í —ç—Ç–æ–º —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.</p>' :
                '<p><strong>‚úÖ –§–∞–π–ª –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω –æ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤</strong></p>'
            }
                `;

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–µ–≤—å—é:', error);
            showAlert('danger', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–µ–≤—å—é: ' + error.message);
        }
    }

    async function createBackups() {
        if (!scanResults) {
            showAlert('warning', '–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ');
            return;
        }

        try {
            console.log('–°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø—ã –¥–ª—è —Ñ–∞–π–ª–æ–≤:', scanResults.files);

            const formData = new FormData();
            formData.append('action', 'backup');
            formData.append('files', JSON.stringify(scanResults.files));

            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–æ–≤:', result);

            if (result.success) {
                showAlert('success', `–ë—ç–∫–∞–ø—ã —Å–æ–∑–¥–∞–Ω—ã: ${result.backup_count} —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ ${result.backup_dir}`);
            } else {
                showAlert('danger', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—ç–∫–∞–ø–æ–≤: ' + (result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–æ–≤:', error);
            showAlert('danger', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—ç–∫–∞–ø–æ–≤: ' + error.message);
        }
    }

    async function cleanDuplicates() {
        if (!scanResults) {
            showAlert('warning', '–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ');
            return;
        }

        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã? –ë—ç–∫–∞–ø—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.')) {
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
        showLoading(true);

        try {
            console.log('–û—á–∏—â–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –≤ —Ñ–∞–π–ª–∞—Ö:', scanResults.files);

            const formData = new FormData();
            formData.append('action', 'clean');
            formData.append('files', JSON.stringify(scanResults.files));

            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—á–∏—Å—Ç–∫–∏:', result);

            showLoading(false);

            if (result.success) {
                showAlert('success', `–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${result.processed_files} —Ñ–∞–π–ª–æ–≤, —É–¥–∞–ª–µ–Ω–æ ${result.total_removed} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.`);

                // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    console.log('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏...');
                    startScan();
                }, 2000);
            } else {
                showAlert('danger', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ: ' + (result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏:', error);
            showLoading(false);
            showAlert('danger', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: ' + error.message);
        }
    }

    function populateStats(stats) {
        const statsGrid = document.getElementById('statsGrid');
        statsGrid.innerHTML = `
                <div class="stat-card">
                    <span class="stat-number">${stats.total_files}</span>
                    <span class="stat-label">–§–∞–π–ª–æ–≤ —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.phosphor_files}</span>
                    <span class="stat-label">Phosphor Icons</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.css_var_files}</span>
                    <span class="stat-label">CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.total_duplicates}</span>
                    <span class="stat-label">–í—Å–µ–≥–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤</span>
                </div>
            `;
    }

    function populateFilesList(files) {
        const filesList = document.getElementById('filesList');
        filesList.innerHTML = '';

        files.forEach(file => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-path">${file.path}</div>
                    </div>
                    <div class="file-stats">
                        ${file.phosphor_duplicates || 0} Phosphor + ${file.css_duplicates || 0} CSS
                    </div>
                `;

            fileItem.addEventListener('click', () => previewFile(file));
            filesList.appendChild(fileItem);
        });
    }

    function showLoading(show) {
        document.getElementById('loadingSection').classList.toggle('show', show);
    }

    function showResults(show) {
        document.getElementById('resultsSection').classList.toggle('show', show);
    }

    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.innerHTML = message;

        const container = document.getElementById('alertContainer');
        container.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    function showDebugInfo() {
        console.log('=== –û–¢–õ–ê–î–û–ß–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===');
        console.log('scanResults:', scanResults);
        console.log('–¢–µ–∫—É—â–∏–π URL:', window.location.href);
        console.log('–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:', document.getElementById('workDir').value);

        // –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        const formData = new FormData();
        formData.append('action', 'scan');
        formData.append('workDir', document.getElementById('workDir').value);

        fetch(window.location.href, {
            method: 'POST',
            body: formData
        })
            .then(response => {
                console.log('–¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç —Å—Ç–∞—Ç—É—Å:', response.status);
                return response.text();
            })
            .then(text => {
                console.log('–¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç —Ç–µ–∫—Å—Ç:', text);
                try {
                    const json = JSON.parse(text);
                    console.log('–¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç JSON:', json);
                } catch(e) {
                    console.log('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:', error);
            });

        showAlert('info', '–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤—ã–≤–µ–¥–µ–Ω–∞ –≤ –∫–æ–Ω—Å–æ–ª—å (F12)');
    }
</script>
</body>
</html>